// Configura√ß√£o da fonte de dados - SUPABASE OU MOCK
// Sistema migrado completamente para Supabase, com suporte a modo demo

const dataSourceFromEnv = process.env.NEXT_PUBLIC_DATA_SOURCE || 'supabase';

export const DATA_SOURCE = {
  current: dataSourceFromEnv as 'supabase' | 'mock',

  apis: {
    supabase: {
      businesses: '/api/supabase/businesses',
      creators: '/api/supabase/creators',
      campaigns: '/api/client/campaigns', // üîí Usar API com filtro de seguran√ßa
      creatorSlots: '/api/supabase/creator-slots',
      addCampaignCreator: '/api/supabase/campaign-creators/add',
      changeCampaignCreator: '/api/supabase/campaign-creators/change',
      removeCampaignCreator: '/api/supabase/campaign-creators/remove'
    }
  }
};

// Helper para obter URL da API
export function getApiUrl(endpoint: keyof typeof DATA_SOURCE.apis.supabase): string {
  const relativeUrl = DATA_SOURCE.apis.supabase[endpoint];

  // Se estamos no servidor (Node.js), usar URL absoluta
  const isServer = typeof window === 'undefined';
  if (isServer) {
    return `http://localhost:3001${relativeUrl}`;
  }

  return relativeUrl;
}

// Helper para verificar se est√° usando Supabase
export function isUsingSupabase(): boolean {
  return DATA_SOURCE.current === 'supabase';
}

// Helper para verificar se est√° usando modo mock
export function isUsingMock(): boolean {
  return DATA_SOURCE.current === 'mock';
}

// Helper para verificar se est√° usando Google Sheets (sempre false agora)
export function isUsingSheets(): boolean {
  return false;
}

// Dados mock para demonstra√ß√£o
const mockBusinesses = [
  {
    id: '1',
    name: 'Loja Fashion Trends',
    businessName: 'Loja Fashion Trends',
    categoria: 'Moda',
    plano: 'Gold',
    responsavel: 'Ana Silva',
    whatsapp: '(11) 99999-1111',
    email: 'ana@fashiontrends.com',
    business_stage: 'Leads pr√≥prios quentes',
    estimated_value: 25000,
    priority: 'Alta',
    journeyStage: 'Reuni√£o Briefing',
    value: 25000,
    description: 'Campanha de ver√£o para roupas femininas'
  },
  {
    id: '2',
    name: 'Restaurante Sabor & Arte',
    businessName: 'Restaurante Sabor & Arte',
    categoria: 'Alimenta√ß√£o',
    plano: 'Silver',
    responsavel: 'Carlos Santos',
    whatsapp: '(11) 99999-2222',
    email: 'carlos@saborarte.com',
    business_stage: 'Enviando proposta',
    estimated_value: 15000,
    priority: 'M√©dia',
    journeyStage: 'Agendamentos',
    value: 15000,
    description: 'Marketing digital para novo card√°pio'
  },
  {
    id: '3',
    name: 'Academia FitLife',
    businessName: 'Academia FitLife',
    categoria: 'Fitness',
    plano: 'Diamond',
    responsavel: 'Maria Oliveira',
    whatsapp: '(11) 99999-3333',
    email: 'maria@fitlife.com',
    business_stage: 'Follow up',
    estimated_value: 35000,
    priority: 'Alta',
    journeyStage: 'Entrega Final',
    value: 35000,
    description: 'Campanha de ano novo fitness'
  }
];

// Fun√ß√£o para buscar neg√≥cios
export async function fetchBusinesses() {
  if (isUsingMock()) {
    console.log('üé≠ Usando dados mock para businesses');
    return mockBusinesses;
  }

  try {
    const response = await fetch(getApiUrl('businesses'));
    const data = await response.json();

    if (!data.success) {
      throw new Error(data.error || 'Erro ao buscar neg√≥cios');
    }

    return data.data;
  } catch (error) {
    console.error('‚ùå Erro ao buscar neg√≥cios do Supabase:', error);
    // Fallback para dados mock em caso de erro
    console.log('üîÑ Usando dados mock como fallback');
    return mockBusinesses;
  }
}

// Fun√ß√£o para buscar criadores do Supabase
export async function fetchCreators() {
  try {
    const response = await fetch(getApiUrl('creators'));
    const data = await response.json();
    
    if (!data.success) {
      throw new Error(data.error || 'Erro ao buscar criadores');
    }
    
    return data.data;
  } catch (error) {
    console.error('‚ùå Erro ao buscar criadores do Supabase:', error);
    throw error;
  }
}

// Fun√ß√£o para buscar campanhas do Supabase com filtro de seguran√ßa
export async function fetchCampaigns() {
  try {
    let apiUrl = getApiUrl('campaigns');
    let businessId: string | null = null;
    let userRole: string | null = null;

    // Obter dados do usu√°rio logado se dispon√≠vel
    if (typeof window !== 'undefined') {
      // Tentar ambas as chaves do localStorage
      const userStr = localStorage.getItem('criadores-auth-storage') || localStorage.getItem('auth-storage');
      console.log('üîç [FETCH CAMPAIGNS] Auth storage raw:', userStr ? 'Existe' : 'N√£o existe');
      console.log('üîç [FETCH CAMPAIGNS] Verificando chaves:', {
        'criadores-auth-storage': !!localStorage.getItem('criadores-auth-storage'),
        'auth-storage': !!localStorage.getItem('auth-storage')
      });

      if (userStr) {
        try {
          const authData = JSON.parse(userStr);
          // Zustand usa estrutura diferente - dados est√£o direto no root
          const user = authData?.user || authData?.state?.user;
          const session = authData?.session || authData?.state?.session;
          const isAuthenticated = authData?.isAuthenticated || authData?.state?.isAuthenticated;

          // Verificar se o usu√°rio est√° realmente autenticado
          if (!isAuthenticated || !user) {
            console.log('‚ö†Ô∏è [FETCH CAMPAIGNS] Usu√°rio n√£o autenticado - cancelando busca');
            return {
              success: true,
              data: [],
              count: 0,
              message: 'Usu√°rio n√£o autenticado'
            };
          }

          businessId = user?.business_id || session?.business_id;
          userRole = user?.role;

          console.log('üë§ [FETCH CAMPAIGNS] Dados do usu√°rio no localStorage:', {
            email: user?.email,
            role: userRole,
            businessId: businessId,
            isAuthenticated: isAuthenticated,
            userBusinessId: user?.business_id,
            sessionBusinessId: session?.business_id,
            hasUser: !!user,
            hasSession: !!session,
            authDataStructure: Object.keys(authData)
          });
        } catch (e) {
          console.warn('‚ö†Ô∏è [FETCH CAMPAIGNS] Erro ao obter dados do usu√°rio:', e);
          return {
            success: false,
            error: 'Erro ao verificar autentica√ß√£o'
          };
        }
      } else {
        console.log('‚ö†Ô∏è [FETCH CAMPAIGNS] Nenhum dado de autentica√ß√£o encontrado no localStorage - cancelando busca');
        return {
          success: true,
          data: [],
          count: 0,
          message: 'Usu√°rio n√£o logado'
        };
      }
    }

    // Determinar qual API usar baseado no role do usu√°rio
    console.log('üîç [FETCH CAMPAIGNS] Verificando role e business_id:', {
      userRole: userRole,
      businessId: businessId,
      isBusinessOwner: userRole === 'business_owner',
      isAdmin: ['admin', 'manager'].includes(userRole || ''),
      hasBusinessId: !!businessId,
      shouldUseSpecificAPI: userRole === 'business_owner' && businessId
    });

    if (userRole === 'business_owner' && businessId) {
      // Business owners usam API espec√≠fica
      apiUrl = `/api/campaigns-by-business?business_id=${businessId}`;
      console.log('üè¢ [FETCH CAMPAIGNS] Business owner detectado - usando API espec√≠fica:', apiUrl);
    } else if (['admin', 'manager'].includes(userRole || '')) {
      // Admins e managers usam API com acesso total
      apiUrl = '/api/client/campaigns';
      console.log('üëë [FETCH CAMPAIGNS] Admin/Manager detectado - usando API com acesso total:', apiUrl);
    } else if (userRole === 'marketing_strategist') {
      // Marketing strategists - TODO: implementar API espec√≠fica
      apiUrl = '/api/client/campaigns';
      console.log('üìà [FETCH CAMPAIGNS] Marketing strategist - usando API padr√£o (TODO: implementar filtro):', apiUrl);
    } else if (!userRole) {
      // Usu√°rio n√£o logado - retornar dados vazios
      console.log('‚ö†Ô∏è [FETCH CAMPAIGNS] Role n√£o definido - usu√°rio n√£o est√° logado');
      return {
        success: true,
        data: [],
        count: 0,
        message: 'Usu√°rio n√£o est√° logado'
      };
    } else {
      // Outros roles usam API padr√£o
      console.log('üîÑ [FETCH CAMPAIGNS] Usando API padr√£o para role:', userRole);
      if (userRole === 'business_owner' && !businessId) {
        console.log('‚ö†Ô∏è [FETCH CAMPAIGNS] Business owner sem business_id');
        return {
          success: false,
          error: 'Business owner sem business_id configurado'
        };
      }
    }

    const response = await fetch(apiUrl, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      }
    });

    const data = await response.json();

    if (!data.success) {
      console.error('‚ùå Erro na API de campanhas:', data.error);
      throw new Error(data.error || 'Erro ao buscar campanhas');
    }

    console.log(`‚úÖ ${data.data.length} campanhas carregadas`);
    if (data.business) {
      console.log(`üè¢ Empresa: ${data.business.name}`);
    }

    return data.data;
  } catch (error) {
    console.error('‚ùå Erro ao buscar campanhas do Supabase:', error);
    throw error;
  }
}

// Fun√ß√£o para buscar jornada de campanhas do Supabase
export async function fetchCampaignJourney() {
  try {
    const campaigns = await fetchCampaigns();
    const businesses = await fetchBusinesses();

    // Transformar dados para formato de jornada
    return transformCampaignsToJourney(campaigns, businesses);
  } catch (error) {
    console.error('‚ùå Erro ao buscar jornada de campanhas do Supabase:', error);
    throw error;
  }
}

// Fun√ß√£o auxiliar para transformar campanhas em formato de jornada
function transformCampaignsToJourney(campaigns: any[], businesses: any[]) {
  console.log('üîÑ Transformando campanhas para jornada:', {
    totalCampaigns: campaigns.length,
    totalBusinesses: businesses.length
  });

  const businessMap = new Map(businesses.map(b => [b.id, b]));

  // Agrupar campanhas por business e m√™s
  const journeyMap = new Map();

  campaigns.forEach(campaign => {
    // Buscar business pelos dados que v√™m da API
    const business = businessMap.get(campaign.businessId);
    if (!business) {
      console.log(`‚ö†Ô∏è Business n√£o encontrado para campanha ${campaign.nome}:`, {
        campaignBusinessId: campaign.businessId,
        campaignBusinessName: campaign.businessName
      });
      return;
    }

    const key = `${campaign.businessName}-${campaign.mes}`;

    if (!journeyMap.has(key)) {
      journeyMap.set(key, {
        id: `journey_${campaign.id}`,
        businessName: campaign.businessName,
        businessId: campaign.businessId,
        mes: campaign.mes,
        journeyStage: campaign.status || 'Reuni√£o de briefing',
        totalCampanhas: 0,
        quantidadeCriadores: campaign.totalCriadores || 0,
        criadores: campaign.criadores || [],
        campanhas: []
      });
    }

    const journeyItem = journeyMap.get(key);
    journeyItem.campanhas.push(campaign);
    journeyItem.totalCampanhas = journeyItem.campanhas.length;
  });

  const result = Array.from(journeyMap.values());
  console.log(`‚úÖ ${result.length} itens de jornada criados:`, result.map(r => ({
    businessName: r.businessName,
    mes: r.mes,
    journeyStage: r.journeyStage,
    totalCampanhas: r.totalCampanhas
  })));

  return result;
}

export default {
  fetchBusinesses,
  fetchCreators,
  fetchCampaigns,
  fetchCampaignJourney,
  isUsingSupabase,
  isUsingSheets,
  getApiUrl
};
